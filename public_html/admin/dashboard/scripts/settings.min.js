const state={editMode:!1,userData:null,currentTab:"profile"};function initializeSettingsPage(){loadUserData(),switchTab(state.currentTab),checkUrlForTab(),document.querySelector('input[type="file"]').onchange=handleProfilePhotoUpload,document.querySelector('button[type="button"]').onclick=toggleEditMode,document.querySelector("form").onsubmit=handleFormSubmit,document.querySelectorAll(".tab-link").forEach((link=>{link.onclick=()=>switchTab(link.getAttribute("data-tab"))})),document.getElementById("mobile-menu-button").onclick=()=>{document.getElementById("mobile-menu").classList.toggle("hidden")}}function switchTab(tabId){state.currentTab=tabId;const url=new URL(window.location);url.searchParams.set("tab",tabId),window.history.pushState({},"",url),document.querySelectorAll(".tab-link").forEach((link=>{const isActive=link.getAttribute("data-tab")===tabId;link.classList.toggle("text-white",isActive),link.classList.toggle("text-gray-200",!isActive),link.closest("#mobile-menu")&&link.classList.toggle("bg-gray-600",isActive)})),document.querySelectorAll(".tab-content").forEach((content=>{content.classList.toggle("hidden",content.id!==`${tabId}-page`)})),document.getElementById("mobile-menu")?.classList.add("hidden")}async function handleProfilePhotoUpload(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader;reader.onload=e=>{document.querySelectorAll('img[alt="Profile"]').forEach((img=>{img.src=e.target.result}))},reader.readAsDataURL(file);try{const formData=new FormData;formData.append("image",file),showLoadingToast("Uploading image...");const response=await fetch("../../../api/admin/adminImage.php",{method:"POST",body:formData});if(!response.ok)throw new Error("Failed to upload image");const result=await response.json();if(!result.status)throw new Error(result.message||"Upload failed");await loadUserData(),showToast("Profile photo updated successfully","success")}catch(error){console.error("Error uploading image:",error),showToast("Failed to upload image: "+error.message,"error")}}function toggleEditMode(){state.editMode=!state.editMode;const inputs=document.querySelectorAll('input:not([type="file"]), select'),editButton=document.querySelector('button[type="button"]'),saveButton=document.querySelector('button[type="submit"]');inputs.forEach((input=>{"SELECT"===input.tagName?input.disabled=!state.editMode:input.readOnly=!state.editMode,input.classList.toggle("bg-gray-50",!state.editMode),input.classList.toggle("bg-white",state.editMode)})),editButton.innerHTML=state.editMode?'<i class="fas fa-times mr-2"></i>Cancel':'<i class="fas fa-edit mr-2"></i>Edit',editButton.classList.toggle("bg-yellow-500",!state.editMode),editButton.classList.toggle("bg-gray-500",state.editMode),saveButton.classList.toggle("hidden",!state.editMode)}async function handleFormSubmit(event){event.preventDefault();const formData=new FormData(event.target),data=Object.fromEntries(formData.entries()),missingFields=["firstName","lastName","email","contact","gender","role"].filter((field=>!data[field]));if(missingFields.length>0)showToast(`Please fill in all required fields: ${missingFields.join(", ")}`,"error");else if(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email))if(/^\+\d{1,4}\s?\d{6,14}$/.test(data.contact)){showLoadingToast("Saving changes...");try{const response=await fetch("../../../api/admin/updateAdmin.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)});if(!response.ok)throw new Error(`HTTP error! status: ${response.status}`);const result=await response.json();if(!result.status)throw new Error(result.message||"Update failed");showToast("Settings updated successfully","success"),toggleEditMode(),await loadUserData()}catch(error){console.error("Error updating settings:",error),showToast(`Failed to update settings: ${error.message}`,"error")}}else showToast("Please enter a valid international phone number (e.g., +1 1234567890)","error");else showToast("Please enter a valid email address","error")}async function loadUserData(){showLoadingToast("Loading your settings...");try{const response=await fetch("../../../api/admin/adminData.php"),result=await response.json();if(!result.status)throw new Error(result.message);const userData=result.data;document.querySelector("h2.text-3xl").textContent=`${userData.firstName||""} ${userData.lastName||""}`;const roleElement=document.querySelector("#adminRole");roleElement&&(roleElement.textContent=userData.role||"");const locationElement=document.querySelector("#adminLocation");locationElement&&(locationElement.textContent=userData.address||""),userData.profilePhoto?document.querySelectorAll('img[alt="Profile"]').forEach((img=>{img.src=userData.profilePhoto})):document.querySelectorAll('img[alt="Profile"]').forEach((img=>{img.src="./images/admin/default.png"})),Object.entries(userData).forEach((([key,value])=>{const input=document.querySelector(`[name="${key}"]`);input&&(input.value=value||"")})),state.userData=userData}catch(error){console.error("Error loading user data:",error),showToast("Failed to load user data: "+error.message,"error")}}function showLoadingToast(message){return Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,didOpen:toast=>{toast.addEventListener("mouseenter",Swal.stopTimer),toast.addEventListener("mouseleave",Swal.resumeTimer)}}).fire({title:message,timer:3e3,timerProgressBar:!0})}function showToast(message,icon="success"){Swal.fire({toast:!0,position:"top-end",icon:icon,title:message,showConfirmButton:!1,timer:3e3})}function checkUrlForTab(){const tabFromUrl=new URLSearchParams(window.location.search).get("tab");tabFromUrl&&["profile","security","payment"].includes(tabFromUrl)&&(state.currentTab=tabFromUrl)}